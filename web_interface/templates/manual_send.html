{% extends "base.html" %}

{% block content %}
<style>
    .emoji-picker {
        display: none;
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        max-width: 320px;
        z-index: 1000;
    }

    .emoji-picker.show {
        display: block;
    }

    .emoji-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 5px;
        max-height: 200px;
        overflow-y: auto;
    }

    .emoji-btn {
        font-size: 24px;
        border: none;
        background: none;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }

    .emoji-btn:hover {
        background: #f0f0f0;
    }

    .image-preview {
        max-width: 100%;
        max-height: 200px;
        margin-top: 10px;
        border-radius: 8px;
        display: none;
    }

    .image-preview.show {
        display: block;
    }

    .btn-remove-image {
        margin-top: 10px;
    }
</style>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">üì§ Enviar Notificaci√≥n Manual</h5>
                <div class="mb-3">
                    <label class="form-label">Mensaje</label>
                    <div class="position-relative">
                        <textarea class="form-control" id="manualMessage" rows="10" placeholder="Escribe tu mensaje aqu√≠..."></textarea>
                        <button class="btn btn-sm btn-outline-secondary position-absolute" style="top: 5px; right: 5px;" onclick="toggleEmojiPicker()">üòä</button>
                        <div id="emojiPicker" class="emoji-picker"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Imagen (opcional)</label>
                    <input type="file" class="form-control" id="imageInput" accept="image/*" onchange="previewImage(event)">
                    <img id="imagePreview" class="image-preview" alt="Preview">
                    <button id="btnRemoveImage" class="btn btn-sm btn-danger btn-remove-image" onclick="removeImage()" style="display: none;">üóëÔ∏è Eliminar Imagen</button>
                </div>
                <button class="btn btn-primary btn-lg" onclick="sendNotification()">üì§ Enviar al Canal de Telegram</button>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">üìú Historial</h5>
                <div id="historyContainer" style="max-height: 500px; overflow-y: auto;">
                    <p class="text-center text-muted">Cargando...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Emoji Picker
const emojis = ['üòÄ','üòÉ','üòÑ','üòÅ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü§©','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','üò£','üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','ü§Ø','üò≥','ü•µ','ü•∂','üò±','üò®','üò∞','üò•','üòì','ü§ó','ü§î','ü§≠','ü§´','ü§•','üò∂','üòê','üòë','üò¨','üôÑ','üòØ','üò¶','üòß','üòÆ','üò≤','ü•±','üò¥','ü§§','üò™','üòµ','ü§ê','ü•¥','ü§¢','ü§Æ','ü§ß','üò∑','ü§í','ü§ï','ü§ë','ü§†','üëç','üëé','üëå','‚úåÔ∏è','ü§û','ü§ù','üëè','üôå','üëê','ü§≤','üôè','‚úçÔ∏è','üí™','ü¶æ','ü¶ø','ü¶µ','ü¶∂','üëÇ','ü¶ª','üëÉ','üß†','ü´Ä','ü´Å','ü¶∑','ü¶¥','üëÄ','üëÅÔ∏è','üëÖ','üëÑ','üíã','ü©∏','üí∞','üíµ','üí¥','üí∂','üí∑','üí∏','üí≥','ü™ô','üíé','‚öñÔ∏è','ü™ú','üß∞','ü™õ','ü™ö','üîß','üî®','‚öíÔ∏è','üõ†Ô∏è','‚õèÔ∏è','ü™ì','ü™É','üí£','üî´','üèπ','üõ°Ô∏è','ü™§','üî™','üó°Ô∏è','‚öîÔ∏è','üö¨','‚ö∞Ô∏è','ü™¶','‚ö±Ô∏è','üè∫','üîÆ','üìø','üßø','üíà','‚öóÔ∏è','üî≠','üî¨','üï≥Ô∏è','ü©π','ü©∫','üíä','üíâ','ü©∏','üß¨','ü¶†','üß´','üß™','üå°Ô∏è','üßπ','ü™†','üß∫','üßª','ü™£','üßº','ü™•','üßΩ','üß¥','üõéÔ∏è','üîë','üóùÔ∏è','üö™','ü™ë','üõãÔ∏è','üõèÔ∏è','üõå','üß∏','üñºÔ∏è','ü™û','ü™ü','üõçÔ∏è','üõí','üéÅ','üéà','üéè','üéÄ','üéä','üéâ','üéé','üèÆ','üéê','üßß','‚úâÔ∏è','üì©','üì®','üìß','üíå','üì•','üì§','üì¶','üè∑Ô∏è','ü™ß','üì™','üì´','üì¨','üì≠','üìÆ','üìØ','üìú','üìÉ','üìÑ','üìë','üßæ','üìä','üìà','üìâ','üóíÔ∏è','üóìÔ∏è','üìÜ','üìÖ','üóëÔ∏è','üìá','üóÉÔ∏è','üó≥Ô∏è','üóÑÔ∏è','üìã','üìÅ','üìÇ','üóÇÔ∏è','üóûÔ∏è','üì∞','üìì','üìî','üìí','üìï','üìó','üìò','üìô','üìö','üìñ','üîñ','üß∑','üîó','üìé','üñáÔ∏è','üìê','üìè','üßÆ','üìå','üìç','‚úÇÔ∏è','üñäÔ∏è','üñãÔ∏è','‚úíÔ∏è','üñåÔ∏è','üñçÔ∏è','üìù','‚úèÔ∏è','üîç','üîé','üîè','üîê','üîí','üîì'];

function initEmojiPicker() {
    const picker = document.getElementById('emojiPicker');
    const grid = document.createElement('div');
    grid.className = 'emoji-grid';

    emojis.forEach(emoji => {
        const btn = document.createElement('button');
        btn.className = 'emoji-btn';
        btn.textContent = emoji;
        btn.onclick = (e) => {
            e.preventDefault();
            insertEmoji(emoji);
        };
        grid.appendChild(btn);
    });

    picker.appendChild(grid);
}

function toggleEmojiPicker() {
    const picker = document.getElementById('emojiPicker');
    picker.classList.toggle('show');
}

function insertEmoji(emoji) {
    const textarea = document.getElementById('manualMessage');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    textarea.value = text.substring(0, start) + emoji + text.substring(end);
    textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
    textarea.focus();
    toggleEmojiPicker();
}

function previewImage(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('imagePreview');
            preview.src = e.target.result;
            preview.classList.add('show');
            document.getElementById('btnRemoveImage').style.display = 'inline-block';
        };
        reader.readAsDataURL(file);
    }
}

function removeImage() {
    document.getElementById('imageInput').value = '';
    document.getElementById('imagePreview').classList.remove('show');
    document.getElementById('btnRemoveImage').style.display = 'none';
}

function sendNotification() {
    const message = document.getElementById('manualMessage').value.trim();
    const imageInput = document.getElementById('imageInput');
    const hasImage = imageInput.files.length > 0;

    if (!message && !hasImage) {
        showToast('warning', 'Campo Vac√≠o', 'Por favor escribe un mensaje o selecciona una imagen');
        return;
    }

    const formData = new FormData();
    formData.append('message', message);
    if (hasImage) {
        formData.append('image', imageInput.files[0]);
    }

    fetch('/api/notifications/send', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('success', 'Notificaci√≥n Enviada', 'El mensaje se envi√≥ correctamente al canal de Telegram');
            document.getElementById('manualMessage').value = '';
            removeImage();
            loadHistory();
        } else {
            showToast('error', 'Error al Enviar', data.error || 'Error desconocido');
        }
    })
    .catch(err => showToast('error', 'Error de Conexi√≥n', err.toString()));
}

function loadHistory() {
    fetch('/api/notifications/history')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const container = document.getElementById('historyContainer');
                container.innerHTML = '';

                if (data.data.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center">No hay notificaciones enviadas</p>';
                    return;
                }

                data.data.forEach(notif => {
                    const item = `
                        <div class="border-bottom pb-2 mb-2">
                            <small class="text-muted">${new Date(notif.sent_at).toLocaleString()}</small>
                            <div class="mt-1" style="white-space: pre-wrap; font-size: 0.9em;">${notif.message || '[Imagen enviada]'}</div>
                            ${notif.success ? '<span class="badge bg-success">‚úì Enviado</span>' : '<span class="badge bg-danger">‚úó Error</span>'}
                        </div>
                    `;
                    container.innerHTML += item;
                });
            }
        })
        .catch(err => console.error('Error:', err));
}

// Close emoji picker when clicking outside
document.addEventListener('click', function(event) {
    const picker = document.getElementById('emojiPicker');
    const emojiBtn = event.target.closest('.btn-outline-secondary');
    if (!picker.contains(event.target) && !emojiBtn) {
        picker.classList.remove('show');
    }
});

initEmojiPicker();
loadHistory();
</script>
{% endblock %}